# èˆå°ä¸åº§ä½äº¤äº’è¡Œä¸ºå¯¹é½å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-17  
**ç‰ˆæœ¬**: é˜¶æ®µ 6.5 åç»­ä¼˜åŒ–  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å¯¹é½èˆå°å’Œåº§ä½çš„äº¤äº’è¡Œä¸ºï¼Œç¡®ä¿ä¸¤è€…åœ¨æ‹–æ‹½ã€ç½‘æ ¼å¸é™„ã€å°ºå¯¸è§„èŒƒç­‰æ–¹é¢ä¿æŒä¸€è‡´ã€‚

---

## ğŸ” é—®é¢˜å‘ç°

### 1. **èˆå°ç§»åŠ¨æ—¶æ²¡æœ‰å¸é™„ç½‘æ ¼** âŒ

**åº§ä½è¡Œä¸º**ï¼ˆå‚è€ƒæ ‡å‡†ï¼‰ï¼š
- æ‹–æ‹½è·ç¦»é˜ˆå€¼åˆ¤æ–­ï¼ˆ3pxï¼‰
- æ‹–æ‹½è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°åæ ‡
- âœ… **æ¾å¼€é¼ æ ‡åå¸é™„åˆ° 10px ç½‘æ ¼**ï¼ˆ`snapToGrid`ï¼‰

**èˆå°è¡Œä¸º**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- æ‹–æ‹½è·ç¦»é˜ˆå€¼åˆ¤æ–­ï¼ˆ3pxï¼‰âœ…
- æ‹–æ‹½è¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°åæ ‡ âœ…
- âŒ **æ¾å¼€é¼ æ ‡åç›´æ¥ä½¿ç”¨æ‹–æ‹½åæ ‡ï¼Œæ²¡æœ‰å¸é™„ç½‘æ ¼**

**ä»£ç ä½ç½®**ï¼š
- `useCanvasInteraction.enhanced.ts` ç¬¬ 484-501 è¡Œ

---

### 2. **èˆå°å°ºå¯¸ä¸æ˜¯ 10 çš„å€æ•°** âŒ

**åº§ä½è¡Œä¸º**ï¼ˆå‚è€ƒæ ‡å‡†ï¼‰ï¼š
- å›ºå®šå°ºå¯¸ 30x30ï¼ˆç¬¦åˆç½‘æ ¼ï¼‰

**èˆå°è¡Œä¸º**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- **é«˜åº¦**ï¼šå¯ä»¥æ˜¯ 40-200 çš„ä»»æ„å€¼ï¼ˆä¸ä¸€å®šæ˜¯ 10 çš„å€æ•°ï¼‰
- **å®½åº¦**ï¼šåŠ¨æ€è®¡ç®—ï¼ˆ`canvasWidth * widthRatio`ï¼‰ï¼Œå¯èƒ½ä¸æ˜¯ 10 çš„å€æ•°

**ä»£ç ä½ç½®**ï¼š
- `StageEditPanel.tsx` ç¬¬ 301-309 è¡Œï¼ˆé«˜åº¦è¾“å…¥ï¼‰
- `canvas.utils.ts` ç¬¬ 490-503 è¡Œï¼ˆå®½åº¦è®¡ç®—ï¼‰

---

### 3. **èˆå°æ‹–æ‹½æ—¶æ²¡æœ‰å®æ—¶è·Ÿéšé¢„è§ˆ** âŒ

**åº§ä½è¡Œä¸º**ï¼ˆå‚è€ƒæ ‡å‡†ï¼‰ï¼š
- æ‹–æ‹½è¿‡ç¨‹ä¸­æ¸²æŸ“ä¸´æ—¶ä½ç½®ï¼ˆå®æ—¶è·Ÿéšé¼ æ ‡ï¼‰
- æ˜¾ç¤ºç½‘æ ¼å¸é™„é¢„è§ˆæ•ˆæœ

**èˆå°è¡Œä¸º**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- âŒ **æ‹–æ‹½è¿‡ç¨‹ä¸­ç›´æ¥æ¸²æŸ“åŸä½ç½®ï¼Œçœ‹ä¸åˆ°å®æ—¶è·Ÿéšæ•ˆæœ**
- åªæœ‰æ¾å¼€é¼ æ ‡åæ‰çœ‹åˆ°æœ€ç»ˆä½ç½®

**ä»£ç ä½ç½®**ï¼š
- `TheaterCanvas.simplified.tsx` ç¬¬ 257-262 è¡Œï¼ˆèˆå°æ¸²æŸ“ï¼‰

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. **èˆå°ç§»åŠ¨å¸é™„ç½‘æ ¼**

**ä¿®å¤ä½ç½®**ï¼š`useCanvasInteraction.enhanced.ts` ç¬¬ 484-506 è¡Œ

```typescript
// â­ é˜¶æ®µ 6.5ï¼šå¤„ç†èˆå°ç§»åŠ¨
if (dragState.dragType === 'stage' && dragState.dragTargetId && onStageMove) {
  const deltaX = worldPos.x - dragState.startX;
  const deltaY = worldPos.y - dragState.startY;
  
  // âœ… è®¡ç®—ç§»åŠ¨è·ç¦»ï¼ˆä¸–ç•Œåæ ‡ï¼‰
  const dragDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
  
  // âœ… åªæœ‰ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼æ‰ç®—çœŸæ­£æ‹–æ‹½
  if (dragDistance >= DRAG_THRESHOLD) {
    // ç§»åŠ¨èˆå°
    const stage = stages.find(s => s.id === dragState.dragTargetId);
    if (stage) {
      let newX = stage.x + deltaX;
      let newY = stage.y + deltaY;
      
      // âœ… ä¸¥æ ¼å¸é™„åˆ°ç½‘æ ¼ï¼ˆ10px å•ä½ï¼Œä¸åº§ä½ä¸€è‡´ï¼‰
      if (enableSnap) {
        newX = snapToGrid(newX);
        newY = snapToGrid(newY);
      }
      
      onStageMove(dragState.dragTargetId, newX, newY);
    }
  }
}
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… æ·»åŠ  `snapToGrid` è°ƒç”¨
- âœ… ä¸åº§ä½ç§»åŠ¨é€»è¾‘å®Œå…¨ä¸€è‡´

---

### 2. **èˆå°é«˜åº¦å¼ºåˆ¶ 10 çš„å€æ•°**

**ä¿®å¤ä½ç½®**ï¼š`StageEditPanel.tsx` ç¬¬ 296-321 è¡Œ

```typescript
<InputNumber
  value={Math.round(selectedStage.height)}
  onChange={(value) => {
    // âœ… å®¹é”™å¤„ç†ï¼šç¡®ä¿é«˜åº¦æ˜¯ 10 çš„å€æ•°ï¼ˆä¸ç½‘æ ¼å¯¹é½ï¼‰
    const roundedValue = value ? Math.round(value / 10) * 10 : 60;
    onUpdateStage(selectedStage.id, { height: roundedValue });
  }}
  placeholder="é«˜åº¦"
  style={{ width: '100%' }}
  min={40}
  max={200}
  step={10}  // âœ… æ­¥é•¿è®¾ä¸º 10ï¼Œç¡®ä¿è¾“å…¥å€¼å¯¹é½
  addonAfter="px"
/>
<div 
  style={{ 
    marginTop: 4, 
    fontSize: 11, 
    color: '#8c8c8c'
  }}
>
  ğŸ’¡ é«˜åº¦è‡ªåŠ¨è°ƒæ•´ä¸º 10 çš„å€æ•°ï¼Œä¸ç½‘æ ¼å¯¹é½
</div>
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… è¾“å…¥æ—¶è‡ªåŠ¨å››èˆäº”å…¥åˆ°æœ€è¿‘çš„ 10 çš„å€æ•°
- âœ… æ­¥é•¿è®¾ä¸º 10
- âœ… æ·»åŠ æç¤ºæ–‡å­—

---

### 3. **èˆå°å®½åº¦å®¹é”™å¤„ç†**

**ä¿®å¤ä½ç½®**ï¼š`canvas.utils.ts` ç¬¬ 490-503 è¡Œï¼ˆ`renderStage` å‡½æ•°ï¼‰

```typescript
export function renderStage(
  ctx: CanvasRenderingContext2D,
  stage: Stage,
  canvasWidth: number = 1200,
  canvasHeight: number = 700,
  isSelected: boolean = false
): void {
  // â­ é˜¶æ®µ 6.5ï¼šæ ¹æ®æ–°å­—æ®µè®¡ç®—å®é™…ä½ç½®å’Œå°ºå¯¸
  // âœ… å®¹é”™å¤„ç†ï¼šç¡®ä¿å®½åº¦æ˜¯ 10 çš„å€æ•°ï¼ˆä¸ç½‘æ ¼å¯¹é½ï¼‰
  const calculatedWidth = canvasWidth * stage.widthRatio;
  const actualWidth = Math.round(calculatedWidth / 10) * 10;
  
  // ä½¿ç”¨èˆå°ä¸­å¿ƒåæ ‡ (x, y) è®¡ç®—å·¦ä¸Šè§’ä½ç½®
  const x = stage.x - actualWidth / 2; // å·¦ä¸Šè§’ X
  const y = stage.y - stage.height / 2; // å·¦ä¸Šè§’ Y
  const height = stage.height;
  
  // ... æ¸²æŸ“é€»è¾‘
}
```

**åŒæ­¥ä¿®å¤ä½ç½®**ï¼š`canvas.utils.ts` ç¬¬ 147-171 è¡Œï¼ˆ`isPointInStage` å‡½æ•°ï¼‰

```typescript
export function isPointInStage(
  x: number,
  y: number,
  stage: Stage,
  canvasWidth: number = 1200
): boolean {
  // âœ… è®¡ç®—èˆå°çš„å®é™…å®½åº¦ï¼ˆç¡®ä¿æ˜¯ 10 çš„å€æ•°ï¼‰
  const calculatedWidth = canvasWidth * stage.widthRatio;
  const actualWidth = Math.round(calculatedWidth / 10) * 10;
  
  // è®¡ç®—èˆå°çš„è¾¹ç•Œï¼ˆåŸºäºä¸­å¿ƒåæ ‡ï¼‰
  const left = stage.x - actualWidth / 2;
  const right = stage.x + actualWidth / 2;
  const top = stage.y - stage.height / 2;
  const bottom = stage.y + stage.height / 2;
  
  return x >= left && x <= right && y >= top && y <= bottom;
}
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… å®½åº¦è®¡ç®—åå››èˆäº”å…¥åˆ°æœ€è¿‘çš„ 10 çš„å€æ•°
- âœ… ç¡®ä¿æ¸²æŸ“å’Œç¢°æ’æ£€æµ‹ä½¿ç”¨ç›¸åŒçš„å®½åº¦è®¡ç®—é€»è¾‘

---

### 4. **èˆå°æ‹–æ‹½å®æ—¶è·Ÿéšé¢„è§ˆ**

**ä¿®å¤ä½ç½®**ï¼š`TheaterCanvas.simplified.tsx` ç¬¬ 257-285 è¡Œï¼ˆèˆå°æ¸²æŸ“ï¼‰

```typescript
// 3. æ¸²æŸ“èˆå°ï¼ˆå¸¦æ‹–æ‹½é¢„è§ˆï¼‰
if (stage) {
  // â­ é˜¶æ®µ 6.5 ä¼˜åŒ–ï¼šåˆ¤æ–­èˆå°æ˜¯å¦è¢«é€‰ä¸­æˆ–æ‚¬åœ
  const isStageSelected = selectedElement?.type === 'stage' && selectedElement.id === stage.id;
  const isStageHovered = hoveredStageId === stage.id;
  
  // âœ… è®¡ç®—ä¸´æ—¶ä½ç½®ï¼ˆæ‹–æ‹½æ—¶å®æ—¶è·Ÿéšé¼ æ ‡ï¼‰
  let displayStage = stage;
  
  if (dragState.isDragging && dragState.dragType === 'stage' && dragState.dragTargetId === stage.id) {
    // è®¡ç®—æ‹–æ‹½åç§»é‡
    const deltaX = dragState.currentX - dragState.startX;
    const deltaY = dragState.currentY - dragState.startY;
    
    // è®¡ç®—ä¸´æ—¶ä½ç½®ï¼ˆå¸¦ç½‘æ ¼å¸é™„é¢„è§ˆï¼‰
    let tempX = stage.x + deltaX;
    let tempY = stage.y + deltaY;
    
    if (enableSnap) {
      tempX = snapToGrid(tempX);
      tempY = snapToGrid(tempY);
    }
    
    // åˆ›å»ºä¸´æ—¶èˆå°å¯¹è±¡ç”¨äºæ¸²æŸ“
    displayStage = { ...stage, x: tempX, y: tempY };
  }
  
  renderStage(ctx, displayStage, width, height, isStageSelected || isStageHovered);
}
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… æ·»åŠ æ‹–æ‹½é¢„è§ˆé€»è¾‘ï¼ˆä¸åº§ä½å®Œå…¨ä¸€è‡´ï¼‰
- âœ… å®æ—¶è®¡ç®—ä¸´æ—¶ä½ç½®ï¼ˆè·Ÿéšé¼ æ ‡ï¼‰
- âœ… æ˜¾ç¤ºç½‘æ ¼å¸é™„é¢„è§ˆæ•ˆæœ
- âœ… åˆ›å»ºä¸´æ—¶èˆå°å¯¹è±¡ç”¨äºæ¸²æŸ“

---

## ğŸ“Š å¯¹é½æ£€æŸ¥æ¸…å•

| äº¤äº’è¡Œä¸º | åº§ä½ | èˆå°ï¼ˆä¿®å¤å‰ï¼‰ | èˆå°ï¼ˆä¿®å¤åï¼‰ | çŠ¶æ€ |
|---------|------|--------------|--------------|------|
| æ‹–æ‹½è·ç¦»é˜ˆå€¼ï¼ˆ3pxï¼‰ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| æ‹–æ‹½æ—¶è·Ÿéšé¼ æ ‡ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| æ¾å¼€åå¸é™„ç½‘æ ¼ | âœ… | âŒ | âœ… | âœ… ä¸€è‡´ |
| å°ºå¯¸æ˜¯ 10 çš„å€æ•° | âœ… (30x30) | âŒ | âœ… | âœ… ä¸€è‡´ |
| é€‰ä¸­/æ‚¬åœè“è‰²é«˜äº® | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| ç‚¹å‡»é€‰ä¸­ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| æ‹–æ‹½ç§»åŠ¨ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| å³ä¾§é¢æ¿ç¼–è¾‘ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |
| åˆ é™¤åŠŸèƒ½ | âœ… | âœ… | âœ… | âœ… ä¸€è‡´ |

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

1. **æ‹–æ‹½è¡Œä¸ºå®Œå…¨å¯¹é½**
   - èˆå°ç°åœ¨ä¸åº§ä½ä¸€æ ·ï¼Œæ¾å¼€é¼ æ ‡åå¸é™„åˆ° 10px ç½‘æ ¼
   - æ‹–æ‹½è·ç¦»é˜ˆå€¼ä¿æŒä¸€è‡´ï¼ˆ3pxï¼‰

2. **å°ºå¯¸è§„èŒƒå®Œå…¨å¯¹é½**
   - èˆå°é«˜åº¦è‡ªåŠ¨è°ƒæ•´ä¸º 10 çš„å€æ•°
   - èˆå°å®½åº¦ï¼ˆè®¡ç®—åï¼‰è‡ªåŠ¨è°ƒæ•´ä¸º 10 çš„å€æ•°
   - æ‰€æœ‰èˆå°å…ƒç´ éƒ½è½åœ¨å®Œæ•´ç½‘æ ¼å†…

3. **è§†è§‰ä¸€è‡´æ€§**
   - èˆå°å’Œåº§ä½éƒ½ä½¿ç”¨è“è‰²é«˜äº®ï¼ˆé€‰ä¸­/æ‚¬åœï¼‰
   - è¾¹æ¡†æ ·å¼å’Œå®½åº¦ä¿æŒä¸€è‡´çš„è§†è§‰é€»è¾‘

4. **æ‹–æ‹½é¢„è§ˆ**
   - èˆå°æ‹–æ‹½æ—¶å®æ—¶è·Ÿéšé¼ æ ‡ï¼Œæ˜¾ç¤ºç½‘æ ¼å¸é™„é¢„è§ˆæ•ˆæœ

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. æ‹–æ‹½æµ‹è¯•
- [ ] æ‹–æ‹½èˆå°ï¼Œæ¾å¼€ååº”å¸é™„åˆ°ç½‘æ ¼ï¼ˆ10px å¯¹é½ï¼‰
- [ ] æ‹–æ‹½åº§ä½ï¼Œæ¾å¼€ååº”å¸é™„åˆ°ç½‘æ ¼ï¼ˆ10px å¯¹é½ï¼‰
- [ ] å¾®å°æ‹–æ‹½ï¼ˆ<3pxï¼‰ä¸åº”è§¦å‘ç§»åŠ¨

### 2. å°ºå¯¸æµ‹è¯•
- [ ] åˆ›å»ºèˆå°ï¼Œé«˜åº¦åº”ä¸º 60ï¼ˆ10 çš„å€æ•°ï¼‰
- [ ] è°ƒæ•´èˆå°é«˜åº¦ï¼Œè¾“å…¥ä»»æ„å€¼åº”è‡ªåŠ¨å››èˆäº”å…¥åˆ° 10 çš„å€æ•°
- [ ] è°ƒæ•´èˆå°å®½åº¦æ¯”ä¾‹ï¼Œæ¸²æŸ“å®½åº¦åº”ä¸º 10 çš„å€æ•°
- [ ] æ£€æŸ¥èˆå°è¾¹ç¼˜æ˜¯å¦å¯¹é½ç½‘æ ¼çº¿

### 3. äº¤äº’æµ‹è¯•
- [ ] ç‚¹å‡»èˆå°åº”é€‰ä¸­ï¼ˆè“è‰²é«˜äº®ï¼‰
- [ ] æ‚¬åœèˆå°åº”æ˜¾ç¤ºè“è‰²è¾¹æ¡†
- [ ] ç‚¹å‡»åº§ä½åº”é€‰ä¸­ï¼ˆè“è‰²é«˜äº®ï¼‰
- [ ] æ‚¬åœåº§ä½åº”æ˜¾ç¤ºè“è‰²è¾¹æ¡†

### 4. æ‹–æ‹½é¢„è§ˆæµ‹è¯•
- [ ] æ‹–æ‹½èˆå°æ—¶åº”å®æ—¶è·Ÿéšé¼ æ ‡ï¼ˆæ˜¾ç¤ºé¢„è§ˆä½ç½®ï¼‰
- [ ] æ‹–æ‹½åº§ä½æ—¶åº”å®æ—¶è·Ÿéšé¼ æ ‡ï¼ˆæ˜¾ç¤ºé¢„è§ˆä½ç½®ï¼‰
- [ ] æ‹–æ‹½æ—¶åº”æ˜¾ç¤ºç½‘æ ¼å¸é™„é¢„è§ˆæ•ˆæœ
- [ ] æ¾å¼€é¼ æ ‡åï¼Œå…ƒç´ åº”å›ºå®šåœ¨å¸é™„ä½ç½®

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ç½‘æ ¼å¸é™„å‡½æ•°

```typescript
export function snapToGrid(
  value: number,
  gridSize: number = GRID_CONFIG.DISPLAY_SIZE // é»˜è®¤ 10px
): number {
  return Math.round(value / gridSize) * gridSize;
}
```

### å°ºå¯¸å®¹é”™å¤„ç†

```typescript
// é«˜åº¦å®¹é”™ï¼ˆç¼–è¾‘é¢æ¿ï¼‰
const roundedValue = value ? Math.round(value / 10) * 10 : 60;

// å®½åº¦å®¹é”™ï¼ˆæ¸²æŸ“é€»è¾‘ï¼‰
const calculatedWidth = canvasWidth * stage.widthRatio;
const actualWidth = Math.round(calculatedWidth / 10) * 10;
```

---

## âœ… éªŒæ”¶æ ‡å‡†

æ‰€æœ‰ä»¥ä¸‹æ¡ä»¶å‡å·²æ»¡è¶³ï¼š

1. âœ… èˆå°æ‹–æ‹½åå¸é™„åˆ° 10px ç½‘æ ¼
2. âœ… èˆå°é«˜åº¦å§‹ç»ˆæ˜¯ 10 çš„å€æ•°
3. âœ… èˆå°å®½åº¦ï¼ˆè®¡ç®—åï¼‰å§‹ç»ˆæ˜¯ 10 çš„å€æ•°
4. âœ… èˆå°å’Œåº§ä½çš„äº¤äº’é€»è¾‘å®Œå…¨ä¸€è‡´
5. âœ… ä»£ç æ³¨é‡Šæ¸…æ™°ï¼Œæ ‡æ³¨äº† âœ… å®¹é”™å¤„ç†

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `/components/theater/seat-map-editor/useCanvasInteraction.enhanced.ts` - äº¤äº’é€»è¾‘
- `/components/theater/seat-map-editor/StageEditPanel.tsx` - èˆå°ç¼–è¾‘é¢æ¿
- `/components/theater/seat-map-editor/canvas.utils.ts` - æ¸²æŸ“å’Œç¢°æ’æ£€æµ‹
- `/components/theater/seat-map-editor/types.simplified.ts` - ç±»å‹å®šä¹‰

---

**æ€»ç»“**ï¼šèˆå°çš„æ‰€æœ‰äº¤äº’è¡Œä¸ºå·²ä¸åº§ä½å®Œå…¨å¯¹é½ï¼ŒåŒ…æ‹¬æ‹–æ‹½ç½‘æ ¼å¸é™„ã€å°ºå¯¸è§„èŒƒã€è§†è§‰åé¦ˆç­‰ï¼Œè¾¾åˆ°äº†"è§‚ä¼—è§†è§’"ç»Ÿä¸€äº¤äº’çš„è®¾è®¡ç›®æ ‡ã€‚