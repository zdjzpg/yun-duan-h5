# 🎯 座位图编辑器简化重构计划

**创建时间：** 2025-12-14  
**状态：** 进行中  
**目标：** 将复杂的座区/走道设计简化为"座位优先"设计

---

## 📋 重构目标

### **核心理念**
```
复杂设计：剧场 → 楼层 → 座区 → 走道 → 舞台 → 座位
简化设计：剧场 → 楼层 → 座位 + 舞台

关键变化：
- ✅ 座位有绝对坐标 (x, y)
- ✅ 座区变成座位的属性字段（zone: string）
- ✅ 走道是隐式的（座位之间的空白）
- ❌ 不再显式绘制座区边界
- ❌ 不再显式绘制走道
```

---

## ✅ 已完成工作

### **1. 新类型定义**
- ✅ 创建 `types.simplified.ts` - 简化的类型系统
  - 简化 `Seat` 类型（删除 rowId, zoneId，添加 zone 字段）
  - 简化 `Floor` 类型（删除 zones, aisles 数组）
  - 简化 `TheaterData` 类型（只包含 floors, seats, stages）
  - 简化 `Tool` 类型（删除 zone, aisle, row 工具）
  - 保留 `Stage` 类型
  - 添加兼容性类型（LegacyZone, LegacyAisle, LegacyRow）

### **2. 数据迁移工具**
- ✅ 创建 `migration.utils.ts` - 数据迁移函数
  - `migrateLegacyData()` - 迁移旧版数据
  - `isLegacyData()` - 检测旧版数据
  - `autoMigrateData()` - 自动检测并迁移
  - `generateBatchSeats()` - 批量生成座位
  - `extractZones()` - 提取唯一座区列表
  - `groupSeatsByZone()` - 按座区分组
  - `calculateStatistics()` - 计算统计信息

### **3. 新组件**
- ✅ 创建 `BatchGenerateModal.tsx` - 批量生成工具
  - 替代旧的 RowPanel（排座工具）
  - 支持拖拽绘制矩形区域
  - 实时预览座位数量
  - 简化配置（无需座区）

---

## ⏳ 待完成工作

### **第 1 批：核心文件重构**

#### **1.1 更新主组件 `index.tsx`**
**优先级：** P0  
**预计工时：** 2h

**变更内容：**
- [ ] 导入简化类型（从 `types.simplified.ts`）
- [ ] 删除 `zones`, `aisles`, `rows` 状态
- [ ] 简化 `floors` 状态（只包含基本信息）
- [ ] 删除绘制状态中的 `zone`, `aisle`
- [ ] 删除座区、走道、排座相关逻辑
- [ ] 集成 `BatchGenerateModal` 替代 `RowPanel`
- [ ] 集成数据迁移工具（`autoMigrateData`）
- [ ] 更新 `onChange` 回调（使用简化数据）

**删除的功能：**
- ❌ 拖拽绘制座区
- ❌ 走道绘制
- ❌ 排座工具（ZonePanel）
- ❌ 座区选中和编辑

**保留的功能：**
- ✅ 单座位工具
- ✅ 批量生成（BatchGenerateModal）
- ✅ 座位拖拽
- ✅ 对齐工具
- ✅ 复制粘贴
- ✅ 撤销重做
- ✅ 键盘快捷键
- ✅ 右键菜单（座位和舞台）
- ✅ 楼层管理
- ✅ 舞台工具

---

#### **1.2 更新 Canvas 组件 `TheaterCanvas.tsx`**
**优先级：** P0  
**预计工时：** 1.5h

**变更内容：**
- [ ] 删除座区绘制逻辑
- [ ] 删除走道绘制逻辑
- [ ] 删除绘制中的矩形预览（座区、走道）
- [ ] 保留座位绘制
- [ ] 保留舞台绘制
- [ ] 保留选中框、对齐辅助线等

**删除的函数：**
- ❌ `renderZones()`
- ❌ `renderAisles()`
- ❌ `renderDrawingRect()` for zone/aisle

**保留的函数：**
- ✅ `renderSeats()`
- ✅ `renderStage()`
- ✅ `renderSelectionBox()`
- ✅ `renderAlignmentGuides()`

---

#### **1.3 更新左侧工具栏 `LeftToolbar.tsx`**
**优先级：** P0  
**预计工时：** 0.5h

**变更内容：**
- [ ] 删除"座区"工具按钮
- [ ] 删除"走道"工具按钮
- [ ] 将"排座"工具改为"批量生成"工具
- [ ] 保留"选择"、"座位"、"舞台"、"平移"工具

**工具列表：**
```tsx
// 旧版（删除）
- select    ✅ 保留
- zone      ❌ 删除
- row       ❌ 删除
- seat      ✅ 保留
- aisle     ❌ 删除
- stage     ✅ 保留
- pan       ✅ 保留

// 新版
- select    ✅ 选择工具
- seat      ✅ 座位工具（单个添加）
- batch     ✅ 批量生成工具
- stage     ✅ 舞台工具
- pan       ✅ 平移工具
```

---

#### **1.4 更新右侧属性面板 `RightPanel.tsx`**
**优先级：** P0  
**预计工时：** 1h

**变更内容：**
- [ ] 删除座区属性显示
- [ ] 删除走道属性显示
- [ ] 保留座位属性显示
- [ ] 保留舞台属性显示
- [ ] 添加座位的"座区"字段编辑（文本输入）

**删除的面板：**
- ❌ ZoneEditPanel
- ❌ AisleEditPanel

**保留的面板：**
- ✅ SeatEditPanel（需添加 zone 字段）
- ✅ StageEditPanel
- ✅ FloorInfoPanel

---

#### **1.5 更新右键菜单 `ContextMenu.tsx`**
**优先级：** P1  
**预计工时：** 0.5h

**变更内容：**
- [ ] 删除座区右键菜单项
- [ ] 删除走道右键菜单项
- [ ] 保留座位右键菜单项
- [ ] 保留舞台右键菜单项

---

#### **1.6 更新底部状态栏 `BottomStatusBar.tsx`**
**优先级：** P1  
**预计工时：** 0.5h

**变更内容：**
- [ ] 更新统计信息（删除座区数、走道数）
- [ ] 添加座区列表显示（从座位提取）
- [ ] 保留楼层切换
- [ ] 保留缩放控制

**统计信息：**
```tsx
// 旧版
- 总座位数 ✅
- 可用座位 ✅
- 座区数   ❌ 删除
- 走道数   ❌ 删除

// 新版
- 总座位数 ✅
- 可用座位 ✅
- 楼层数   ✅
- 舞台数   ✅
- 座区列表 ✅ 新增（从座位提取）
```

---

### **第 2 批：删除废弃组件**

#### **2.1 删除组件文件**
**优先级：** P1  
**预计工时：** 0.5h

**待删除文件：**
- [ ] `ZonePanel.tsx` - 座区编辑面板
- [ ] `RowPanel.tsx` - 排座工具（已被 BatchGenerateModal 替代）

**保留文件：**
- ✅ `SingleSeatModal.tsx` - 单座位工具
- ✅ `SeatEditPanel.tsx` - 座位属性编辑
- ✅ `FloorManagerModal.tsx` - 楼层管理
- ✅ `RenumberModal.tsx` - 批量编号
- ✅ `BatchGenerateModal.tsx` - 批量生成（新）

---

#### **2.2 更新工具函数 `utils.ts`**
**优先级：** P1  
**预计工时：** 0.5h

**变更内容：**
- [ ] 删除座区相关函数
- [ ] 删除走道相关函数
- [ ] 删除排座相关函数
- [ ] 保留座位相关函数
- [ ] 集成迁移工具函数

**删除的函数：**
- ❌ `calculateZoneBounds()`
- ❌ `isPointInZone()`
- ❌ `generateRowSeats()`

**保留的函数：**
- ✅ `generateId()`
- ✅ `calculateDistance()`
- ✅ `alignSeats()`
- ✅ `distributeSeats()`

---

#### **2.3 更新常量 `constants.ts`**
**优先级：** P2  
**预计工时：** 0.2h

**变更内容：**
- [ ] 删除 `ZONE_COLORS`（座区不再需要颜色）
- [ ] 删除 `AISLE_COLOR`（走道不再需要）
- [ ] 保留 `SEAT_SIZE`, `SEAT_SPACING`, `STAGE_COLOR`

---

### **第 3 批：更新测试文档**

#### **3.1 创建简化版测试指南**
**优先级：** P2  
**预计工时：** 1h

**内容：**
- [ ] 创建 `SIMPLIFIED_TESTING_GUIDE.md`
- [ ] 更新测试用例（删除座区、走道测试）
- [ ] 添加批量生成测试
- [ ] 添加数据迁移测试

---

#### **3.2 更新文档**
**优先级：** P2  
**预计工时：** 0.5h

**内容：**
- [ ] 更新 `README.md`（如果有）
- [ ] 创建 `SIMPLIFICATION_COMPLETED.md`
- [ ] 更新 `MIGRATION.md`（标记简化重构完成）

---

## 📊 工作量统计

| 任务 | 优先级 | 预计工时 | 状态 |
|------|--------|---------|------|
| **第 1 批：核心文件重构** | P0 | 6h | ⏳ |
| 1.1 更新主组件 | P0 | 2h | ⏳ |
| 1.2 更新 Canvas | P0 | 1.5h | ⏳ |
| 1.3 更新左侧工具栏 | P0 | 0.5h | ⏳ |
| 1.4 更新右侧面板 | P0 | 1h | ⏳ |
| 1.5 更新右键菜单 | P1 | 0.5h | ⏳ |
| 1.6 更新底部状态栏 | P1 | 0.5h | ⏳ |
| **第 2 批：删除废弃组件** | P1 | 1.2h | ⏳ |
| 2.1 删除组件文件 | P1 | 0.5h | ⏳ |
| 2.2 更新工具函数 | P1 | 0.5h | ⏳ |
| 2.3 更新常量 | P2 | 0.2h | ⏳ |
| **第 3 批：更新测试文档** | P2 | 1.5h | ⏳ |
| 3.1 创建测试指南 | P2 | 1h | ⏳ |
| 3.2 更新文档 | P2 | 0.5h | ⏳ |
| **总计** | - | **8.7h** | **⏳** |

---

## 🎯 实施流程

### **阶段 1：核心重构（优先级 P0）**
```
1. 更新 index.tsx（主组件）
2. 更新 TheaterCanvas.tsx（Canvas 渲染）
3. 更新 LeftToolbar.tsx（工具栏）
4. 更新 RightPanel.tsx（属性面板）
→ 预计 5.5h，完成后编辑器基本可用
```

### **阶段 2：完善功能（优先级 P1）**
```
1. 更新 ContextMenu.tsx（右键菜单）
2. 更新 BottomStatusBar.tsx（状态栏）
3. 删除废弃组件
4. 更新工具函数
→ 预计 2h，完成后功能完整
```

### **阶段 3：文档和测试（优先级 P2）**
```
1. 创建测试指南
2. 更新文档
→ 预计 1.5h，完成后项目完成
```

---

## ⚠️ 兼容性保证

### **数据迁移**
- ✅ 自动检测旧版数据
- ✅ 自动迁移到简化格式
- ✅ 保留所有座位信息
- ✅ 将座区名称保存到 `seat.zone` 字段

### **向后兼容**
- ✅ 旧版数据可以正常打开
- ✅ 迁移后数据不丢失
- ✅ 保留 LegacyXXX 类型用于迁移

---

## 🚀 下一步行动

**当前状态：** 已完成基础设施（类型、迁移工具、批量生成组件）  
**下一步：** 开始重构核心文件

**立即开始：**
1. 重构 `index.tsx` 主组件
2. 重构 `TheaterCanvas.tsx` 渲染逻辑
3. 重构 `LeftToolbar.tsx` 工具栏

---

**创建时间：** 2025-12-14  
**更新时间：** 2025-12-14  
**状态：** 进行中 ⏳
