# åº§ä½å›¾ç¼–è¾‘å™¨ - ç”»å¸ƒè‡ªé€‚åº”åŠŸèƒ½å®ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-17  
**åŠŸèƒ½**: ç”»å¸ƒè‡ªé€‚åº”å±å¹•å°ºå¯¸  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ éœ€æ±‚èƒŒæ™¯

**åŸé—®é¢˜**ï¼š
- Canvas ä½¿ç”¨å›ºå®šå°ºå¯¸ï¼ˆ1200x700ï¼‰
- æ— æ³•å……åˆ†åˆ©ç”¨å·¦å³ä¾§è¾¹æ ä¹‹é—´çš„å¯ç”¨ç©ºé—´
- ä¸åŒå±å¹•å°ºå¯¸ä¸‹ç¼–è¾‘ä½“éªŒä¸ä½³

**ç›®æ ‡**ï¼š
- Canvas è‡ªåŠ¨å¡«å……å·¦å³ä¾§é¢æ¿ä¹‹é—´çš„å¯ç”¨åŒºåŸŸ
- å“åº”çª—å£/é¢æ¿å°ºå¯¸å˜åŒ–
- ä¿æŒåº§ä½åæ ‡ç³»ç»Ÿç¨³å®š

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### 1. **åˆ›å»º useCanvasResize Hook**

**æ–‡ä»¶**ï¼š`/components/theater/seat-map-editor/useCanvasResize.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ä½¿ç”¨ `ResizeObserver` API ç›‘å¬å®¹å™¨å°ºå¯¸å˜åŒ–
- å®æ—¶è®¡ç®— Canvas å¯ç”¨å®½åº¦å’Œé«˜åº¦
- è®¾ç½®æœ€å°å°ºå¯¸é™åˆ¶ï¼ˆ800x600ï¼‰

**å…³é”®ä»£ç **ï¼š
```typescript
export function useCanvasResize(
  containerRef: RefObject<HTMLElement>,
  padding: number = 0
): CanvasSize {
  const [size, setSize] = useState<CanvasSize>({
    width: 1200,
    height: 700,
  });

  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const resizeObserver = new ResizeObserver((entries) => {
      for (const entry of entries) {
        const { width, height } = entry.contentRect;
        
        // è®¡ç®—å®é™…å¯ç”¨å°ºå¯¸ï¼ˆå‡å»å†…è¾¹è·ï¼Œè®¾ç½®æœ€å°å€¼ï¼‰
        const availableWidth = Math.max(800, width - padding * 2);
        const availableHeight = Math.max(600, height - padding * 2);
        
        setSize({
          width: availableWidth,
          height: availableHeight,
        });
      }
    });

    resizeObserver.observe(container);

    return () => {
      resizeObserver.disconnect();
    };
  }, [containerRef, padding]);

  return size;
}
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ ResizeObserver APIï¼ˆç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼ˆuseEffect cleanupï¼‰
- âœ… åˆå§‹åŒ–æ—¶ç«‹å³è§¦å‘ä¸€æ¬¡è®¡ç®—
- âœ… æœ€å°å°ºå¯¸ä¿æŠ¤ï¼ˆé¿å…è¿‡å°ï¼‰

---

### 2. **ä¿®æ”¹ CanvasArea ç»„ä»¶æ”¯æŒ ref è½¬å‘**

**æ–‡ä»¶**ï¼š`/components/theater/seat-map-editor/CanvasArea.tsx`

**å…³é”®æ”¹åŠ¨**ï¼š
```typescript
// ä¿®æ”¹å‰ï¼šæ™®é€šå‡½æ•°ç»„ä»¶
export function CanvasArea({ ... }: CanvasAreaProps) {
  return (
    <div>
      <div style={{...}}> {/* æ— æ³•ä¼ é€’ ref */}
        {canvas}
      </div>
    </div>
  );
}

// ä¿®æ”¹åï¼šä½¿ç”¨ forwardRef
export const CanvasArea = forwardRef<HTMLDivElement, CanvasAreaProps>(
  ({ canvas, statusBar, isInModal = false }, ref) => {
    return (
      <div>
        <div
          ref={ref}  // âœ… æ¥æ”¶ refï¼Œç”¨äºå°ºå¯¸ç›‘å¬
          style={{...}}
        >
          {canvas}
        </div>
      </div>
    );
  }
);

CanvasArea.displayName = 'CanvasArea';
```

**æŠ€æœ¯è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `forwardRef` è½¬å‘ ref åˆ° Canvas å®¹å™¨
- âœ… æ·»åŠ  `displayName`ï¼ˆReact DevTools æ˜¾ç¤ºï¼‰

---

### 3. **ä¿®æ”¹ä¸»ç¼–è¾‘å™¨ç»„ä»¶ä½¿ç”¨åŠ¨æ€å°ºå¯¸**

**æ–‡ä»¶**ï¼š`/components/theater/seat-map-editor/index.layout-refactor.tsx`

**æ­¥éª¤ 1ï¼šå¯¼å…¥ Hook å’Œåˆ›å»º ref**
```typescript
import { useCanvasResize } from './useCanvasResize'; // âœ… æ–°å¢

export function SeatMapEditor({ ... }: SeatMapEditorProps) {
  // Canvas å®¹å™¨å¼•ç”¨ï¼ˆç”¨äºå°ºå¯¸ç›‘å¬ï¼‰
  const canvasContainerRef = useRef<HTMLDivElement>(null);
  
  // âœ… ä½¿ç”¨ Hook ç›‘å¬å®¹å™¨å°ºå¯¸å˜åŒ–ï¼Œå®ç°ç”»å¸ƒè‡ªé€‚åº”
  const canvasSize = useCanvasResize(canvasContainerRef, 0);
  
  // ...
}
```

**æ­¥éª¤ 2ï¼šä¼ é€’ ref åˆ° CanvasArea**
```typescript
<CanvasArea
  ref={canvasContainerRef}  // âœ… ä¼ é€’ ref
  isInModal={isInModal}
  canvas={...}
/>
```

**æ­¥éª¤ 3ï¼šä½¿ç”¨åŠ¨æ€å°ºå¯¸æ¸²æŸ“ Canvas**
```typescript
<TheaterCanvasSimplified
  seats={floorSeats}
  stage={stage}
  // ...
  width={canvasSize.width}   // âœ… åŠ¨æ€å®½åº¦
  height={canvasSize.height} // âœ… åŠ¨æ€é«˜åº¦
  // ...
/>
```

---

## ğŸ“Š å¸ƒå±€ç»“æ„åˆ†æ

### åŸå§‹å¸ƒå±€ï¼ˆå›ºå®šå°ºå¯¸ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¶éƒ¨å·¥å…·æ  (Header)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚                      â”‚                â”‚
â”‚ å·¦ä¾§æ   â”‚  Canvas å®¹å™¨          â”‚  å³ä¾§å±æ€§é¢æ¿   â”‚
â”‚ 240px  â”‚  (flex: 1)           â”‚  320px         â”‚
â”‚        â”‚                      â”‚                â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                â”‚
â”‚        â”‚  â”‚   Canvas     â”‚    â”‚                â”‚
â”‚        â”‚  â”‚  1200x700    â”‚    â”‚                â”‚  âŒ å›ºå®šå°ºå¯¸
â”‚        â”‚  â”‚   (å›ºå®š)     â”‚    â”‚                â”‚
â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                â”‚
â”‚        â”‚                      â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªé€‚åº”å¸ƒå±€ï¼ˆåŠ¨æ€å°ºå¯¸ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¶éƒ¨å·¥å…·æ  (Header)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚                      â”‚                â”‚
â”‚ å·¦ä¾§æ   â”‚  Canvas å®¹å™¨          â”‚  å³ä¾§å±æ€§é¢æ¿   â”‚
â”‚ 240px  â”‚  (flex: 1)           â”‚  320px         â”‚
â”‚        â”‚                      â”‚                â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚
â”‚        â”‚  â”‚                â”‚  â”‚                â”‚
â”‚        â”‚  â”‚    Canvas      â”‚  â”‚                â”‚  âœ… è‡ªé€‚åº”
â”‚        â”‚  â”‚  (è‡ªåŠ¨å¡«å……)     â”‚  â”‚                â”‚
â”‚        â”‚  â”‚                â”‚  â”‚                â”‚
â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚        â”‚                      â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…å¯ç”¨å®½åº¦ = çª—å£å®½åº¦ - 240px - 320px - è¾¹è·
å®é™…å¯ç”¨é«˜åº¦ = çª—å£é«˜åº¦ - Headeré«˜åº¦ - è¾¹è·
```

---

## ğŸ¨ æŠ€æœ¯ç»†èŠ‚

### ResizeObserver API ä¼˜åŠ¿

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **window.resize äº‹ä»¶** | ç®€å•ç›´æ¥ | åªç›‘å¬çª—å£å˜åŒ–ï¼Œä¸ç›‘å¬å®¹å™¨ |
| **IntersectionObserver** | ç›‘å¬å¯è§æ€§ | ä¸ç›‘å¬å°ºå¯¸å˜åŒ– |
| **âœ… ResizeObserver** | ç²¾ç¡®ç›‘å¬å®¹å™¨å°ºå¯¸ | éœ€è¦ç°ä»£æµè§ˆå™¨ |

**æµè§ˆå™¨å…¼å®¹æ€§**ï¼š
- Chrome 64+
- Firefox 69+
- Safari 13.1+
- Edge 79+

---

### åæ ‡ç³»ç»Ÿç¨³å®šæ€§ä¿éšœ

**å…³é”®ç‚¹**ï¼šCanvas å°ºå¯¸å˜åŒ–ä¸å½±å“åº§ä½åæ ‡ç³»ç»Ÿ

```typescript
// åº§ä½åæ ‡ï¼šæ°¸è¿œåŸºäºä¸–ç•Œåæ ‡ç³»ï¼ˆ0, 0ä¸ºä¸­å¿ƒï¼‰
const seat = {
  x: 100,  // âœ… åæ ‡ä¸å˜
  y: 200,  // âœ… åæ ‡ä¸å˜
};

// è§†å£ï¼ˆViewportï¼‰ï¼šè´Ÿè´£ç¼©æ”¾å’Œå¹³ç§»
const viewport = {
  offsetX: canvasSize.width / 2,   // âœ… è‡ªåŠ¨è°ƒæ•´åç§»é‡
  offsetY: canvasSize.height / 2,  // âœ… è‡ªåŠ¨è°ƒæ•´åç§»é‡
  scale: 1,
};

// æ¸²æŸ“æ—¶çš„å˜æ¢é€»è¾‘ï¼š
ctx.translate(viewport.offsetX, viewport.offsetY);  // âœ… è§†å£å±…ä¸­
ctx.scale(viewport.scale, viewport.scale);          // ç¼©æ”¾
ctx.fillRect(seat.x, seat.y, 30, 30);              // ç»˜åˆ¶åº§ä½
```

**ä¼˜åŠ¿**ï¼š
- âœ… åº§ä½åæ ‡ä¸ Canvas å°ºå¯¸è§£è€¦
- âœ… çª—å£ç¼©æ”¾æ—¶åº§ä½ä½ç½®ä¸å˜
- âœ… æ”¯æŒå¤šç§å±å¹•å°ºå¯¸

---

## ğŸ“ å°ºå¯¸é™åˆ¶è¯´æ˜

### æœ€å°å°ºå¯¸è®¾ç½®

```typescript
const availableWidth = Math.max(800, width - padding * 2);
const availableHeight = Math.max(600, height - padding * 2);
```

**åŸå› **ï¼š
1. **å¯ç”¨æ€§**ï¼šå¤ªå°çš„ç”»å¸ƒæ— æ³•æœ‰æ•ˆç¼–è¾‘
2. **æ€§èƒ½**ï¼šé¿å…æç«¯å°ºå¯¸å¯¼è‡´æ¸²æŸ“é—®é¢˜
3. **ä½“éªŒ**ï¼šä¿è¯åŸºæœ¬çš„å·¥ä½œåŒºåŸŸ

### ä¸åŒå±å¹•é€‚é…

| å±å¹•å°ºå¯¸ | å¯ç”¨å®½åº¦ä¼°ç®— | Canvas å®½åº¦ | ä½“éªŒ |
|---------|------------|------------|------|
| 1920x1080 (å…¨å±) | ~1360px | ~1360px | âœ… ä¼˜ç§€ |
| 1440x900 | ~880px | ~880px | âœ… è‰¯å¥½ |
| 1366x768 | ~806px | ~806px | âš ï¸ ä¸€èˆ¬ |
| < 1280 | < 720px | 800px (æœ€å°) | âš ï¸ å‹‰å¼º |

**å»ºè®®**ï¼šæ¨èä½¿ç”¨ 1440px ä»¥ä¸Šå®½åº¦çš„å±å¹•

---

## âœ… æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

- [ ] **çª—å£ç¼©æ”¾**ï¼šè°ƒæ•´æµè§ˆå™¨çª—å£å¤§å°ï¼ŒCanvas åº”å®æ—¶è‡ªé€‚åº”
- [ ] **ä¾§è¾¹æ å±•å¼€/æ”¶èµ·**ï¼šå¦‚æœä¾§è¾¹æ æ”¯æŒåŠ¨æ€å®½åº¦ï¼ŒCanvas åº”åŒæ­¥è°ƒæ•´
- [ ] **åº§ä½åæ ‡ç¨³å®š**ï¼šçª—å£ç¼©æ”¾åï¼Œåº§ä½ç›¸å¯¹ä½ç½®ä¸å˜
- [ ] **æœ€å°å°ºå¯¸ä¿æŠ¤**ï¼šæå°çª—å£ä¸‹ï¼ŒCanvas ä¸å°äº 800x600

### æ€§èƒ½æµ‹è¯•

- [ ] **ResizeObserver æ€§èƒ½**ï¼šå¿«é€Ÿè°ƒæ•´çª—å£å¤§å°æ—¶æ— æ˜æ˜¾å¡é¡¿
- [ ] **å¤§é‡åº§ä½æ¸²æŸ“**ï¼š500+ åº§ä½æ—¶ï¼Œè‡ªé€‚åº”æ— æ€§èƒ½é—®é¢˜
- [ ] **å†…å­˜æ³„æ¼**ï¼šå¤šæ¬¡è°ƒæ•´çª—å£å¤§å°åï¼Œå†…å­˜å ç”¨æ­£å¸¸

### å…¼å®¹æ€§æµ‹è¯•

- [ ] Chrome/Edge æœ€æ–°ç‰ˆ
- [ ] Firefox æœ€æ–°ç‰ˆ
- [ ] Safari æœ€æ–°ç‰ˆ

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. **é˜²æŠ–ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰

```typescript
// å¦‚æœ resize äº‹ä»¶è¿‡äºé¢‘ç¹ï¼Œå¯ä»¥æ·»åŠ é˜²æŠ–
const [size, setSize] = useState<CanvasSize>({ width: 1200, height: 700 });
const debounceTimerRef = useRef<number>();

useEffect(() => {
  const resizeObserver = new ResizeObserver((entries) => {
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }
    
    debounceTimerRef.current = window.setTimeout(() => {
      // æ›´æ–°å°ºå¯¸é€»è¾‘
      setSize({ ... });
    }, 100); // 100ms é˜²æŠ–
  });
  
  // ...
}, []);
```

### 2. **å“åº”å¼æ–­ç‚¹**ï¼ˆå¯é€‰ï¼‰

```typescript
// æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´å¸ƒå±€
const getLayoutMode = (width: number) => {
  if (width < 1280) return 'compact';   // ç´§å‡‘æ¨¡å¼
  if (width < 1600) return 'normal';    // æ­£å¸¸æ¨¡å¼
  return 'wide';                        // å®½å±æ¨¡å¼
};
```

### 3. **å…¨å±æ¨¡å¼æ”¯æŒ**ï¼ˆå¯é€‰ï¼‰

```typescript
// æ·»åŠ å…¨å±æŒ‰é’®ï¼Œéšè—å·¦å³ä¾§è¾¹æ 
const [isFullscreen, setIsFullscreen] = useState(false);

// å…¨å±æ—¶ Canvas å®½åº¦ = çª—å£å®½åº¦ - è¾¹è·
```

---

## ğŸ“ æ€»ç»“

**å®ç°æˆæœ**ï¼š
- âœ… Canvas å®Œå…¨è‡ªé€‚åº”å·¦å³ä¾§è¾¹æ ä¹‹é—´çš„å¯ç”¨ç©ºé—´
- âœ… å“åº”çª—å£/é¢æ¿å°ºå¯¸å˜åŒ–
- âœ… åº§ä½åæ ‡ç³»ç»Ÿä¿æŒç¨³å®š
- âœ… æœ€å°å°ºå¯¸ä¿æŠ¤ï¼ˆ800x600ï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- ResizeObserver APIï¼ˆåŸç”Ÿæµè§ˆå™¨ APIï¼‰
- React forwardRefï¼ˆref è½¬å‘ï¼‰
- Custom Hookï¼ˆuseCanvasResizeï¼‰

**ç”¨æˆ·ä½“éªŒæå‡**ï¼š
- ğŸ’¡ å……åˆ†åˆ©ç”¨å±å¹•ç©ºé—´ï¼Œå‡å°‘æ»šåŠ¨
- ğŸ’¡ å¤§å±ç”¨æˆ·è·å¾—æ›´å¤§ç¼–è¾‘åŒºåŸŸ
- ğŸ’¡ çª—å£è°ƒæ•´æ—¶å®æ—¶å“åº”

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-12-17
