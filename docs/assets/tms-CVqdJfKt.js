import{h as Ae,t as v,l as Q,aF as z,aM as k,aH as p,aK as c,aJ as d,p as f,be as me,aO as C,bN as dt,bL as oe,aS as Pe,b as S,k as vt,m as ft,aG as D,F,aL as L,aP as g,ad as E,bO as pt,aI as ze,aV as mt,bP as _t,bQ as ht,aZ as gt,aY as wt,b9 as Me,aU as se}from"./demo-DLJTFP0Q.js";import{_ as yt,f as St,a as bt,b as Ee}from"./theater-CU-PiVpP.js";const kt={class:"y-date-footer"},Ct=Ae({__name:"YDatePicker",props:{value:{}},emits:["update:value","change"],setup(Ne,{emit:le}){const G=Ne,B=le,b=v(!1),M=v(G.value??null);Q(()=>G.value,w=>{M.value=w??null}),Q(M,w=>{B("update:value",w)});const $=w=>{b.value=w},W=(w,h)=>{B("change",w,h)},O=w=>{if(w==="close"){b.value=!1;return}if(w==="clear"){M.value=null;return}w==="now"&&(M.value=oe())};return(w,h)=>{const Z=z("a-button"),j=z("a-date-picker");return p(),k(j,dt({value:M.value,"onUpdate:value":h[3]||(h[3]=Y=>M.value=Y),open:b.value,"show-today":!1,"allow-clear":!1},w.$attrs,{onOpenChange:$,onChange:W}),{renderExtraFooter:c(()=>[d("div",kt,[f(Z,{onClick:h[0]||(h[0]=me(Y=>O("close"),["stop"])),class:"button button-close"},{default:c(()=>[...h[4]||(h[4]=[C(" 关闭 ",-1)])]),_:1}),d("div",null,[f(Z,{onClick:h[1]||(h[1]=me(Y=>O("clear"),["stop"])),class:"button button-clear"},{default:c(()=>[...h[5]||(h[5]=[C(" 清空 ",-1)])]),_:1}),f(Z,{type:"primary",onClick:h[2]||(h[2]=me(Y=>O("now"),["stop"])),class:"button button-now"},{default:c(()=>[...h[6]||(h[6]=[C(" 现在时间 ",-1)])]),_:1})])])]),_:1},16,["value","open"])}}}),xt=Pe(Ct,[["__scopeId","data-v-04411221"]]),It={class:"ticketing-sale"},Tt={class:"filter-row"},zt={class:"filter-content"},Mt={class:"show-dropdown"},Nt={class:"filter-row"},$t={class:"filter-content"},Dt={class:"filter-row"},Bt={class:"filter-content"},Ot={class:"filter-row"},Yt={class:"filter-content filter-content--between"},Vt={class:"ticketing-sale__body"},Ft={class:"canvas-header"},Lt={class:"canvas-title"},Et={class:"canvas-title__name"},At={class:"canvas-title__sub"},Pt={class:"canvas-actions"},Ut={class:"cart-header"},Rt={class:"cart-title"};const Xt={class:"cart-content"},Ht={class:"cart-session-card__row"},Gt={class:"cart-session-card__text"},Wt={class:"cart-tier-card__header"},Zt={class:"cart-tier-card__title"},jt={class:"cart-tier-card__seats"};const Kt={class:"cart-footer"},Jt={class:"total"},Qt={class:"total__amount"},qt=3,ea=Ae({__name:"index",setup(Ne){const le=v(!1),G=v(!1),B=v(""),b=v([]),M=v([]),$=v(""),W=v(""),O=v([]),w=v([]),h=v({}),Z=v(""),j=v([]),Y=v([]),_e=v(void 0),ie={},re=v({}),he=v({}),q=v(null),y=v(""),ee=v(""),A=v([]),P=v({offsetX:400,offsetY:300,scale:1}),ge=v(null),U=v({width:900,height:620}),we=v(!1);let te=null;const Ue=()=>{!ge.value||typeof ResizeObserver>"u"||(te?.disconnect(),te=new ResizeObserver(t=>{const e=t[0];if(!e)return;const a=e.contentRect;U.value={width:Math.max(360,Math.floor(a.width)),height:Math.max(360,Math.floor(a.height))},we.value||(Te(),we.value=!0)}),te.observe(ge.value))},x=v({}),ye=v(0),ae=v({});function Se(t,e){return`${t}__${e}`}const R=v(!1),be=v(!1),Re=S(()=>{const t=B.value.trim().toLowerCase();return t?b.value.filter(e=>e.name.toLowerCase().includes(t)):b.value}),$e=S(()=>(M.value.length?M.value:b.value).slice(0,qt)),Xe=S(()=>{if(!$.value)return $e.value;const t=b.value.find(a=>a.id===$.value),e=$e.value.filter(a=>a.id!==$.value);return t?[t,...e]:e}),De=S(()=>{const t=new Map;return O.value.forEach(e=>{t.has(e.date)||t.set(e.date,[]),t.get(e.date).push(e)}),Array.from(t.values()).forEach(e=>e.sort((a,o)=>(a.startTime||"").localeCompare(o.startTime||""))),t}),Be=S(()=>Array.from(De.value.keys()).sort()),ke=S(()=>(ce.value||[]).find(t=>t.id===y.value)||O.value.find(t=>t.id===y.value)||null),ce=S(()=>{const t=q.value,e=t?t.format("YYYY-MM-DD"):"";if(!e)return[];const a=[...De.value.get(e)||[]];if(!a.length)return[];const o=oe(),l=o.format("YYYY-MM-DD");if(e===l){const s=[],u=[];return a.forEach(i=>{oe(`${i.date} ${i.startTime}`).isBefore(o)?u.push(i):s.push(i)}),s.sort((i,r)=>(i.startTime||"").localeCompare(r.startTime||"")),u.sort((i,r)=>(i.startTime||"").localeCompare(r.startTime||"")),[...s,...u]}return a.sort((s,u)=>(s.startTime||"").localeCompare(u.startTime||"")),a}),ue=S(()=>{const t=[...w.value],a=ke.value?.venueId;if(a){const o=he.value[a]||[],l=new Set(o);l.size&&t.splice(0,t.length,...t.filter(s=>{const u=s.zoneIds||[];return u.length?u.some(i=>l.has(i)):!0}))}return t.sort((o,l)=>(o.name||"").localeCompare(l.name||"")),t}),He=S(()=>{const t=new Map;return ue.value.forEach(e=>{(e.zoneIds||[]).forEach(a=>t.set(a,e))}),t});function Ge(t){let e=2166136261;for(let a=0;a<t.length;a++)e^=t.charCodeAt(a),e=Math.imul(e,16777619);return e>>>0}const We=S(()=>{const t=y.value,e=new Set,a=new Set;if(!t)return{sold:e,showDisabled:a};for(const o of Y.value){const l=String(o.id),s=Ge(`${t}|${l}|${ye.value}`)%100;s<12?e.add(l):s<16&&a.add(l)}return{sold:e,showDisabled:a}}),K=S(()=>{const t=ee.value,{sold:e,showDisabled:a}=We.value,o=A.value,l=o.length>0;return Y.value.filter(s=>t?s.floorId===t:!0).map(s=>{const u=He.value.get(s.zoneId),i=u?.id,r=e.has(String(s.id)),m=a.has(String(s.id)),_=s.status==="disabled",I=!(l?i?o.includes(i):!1:!0);return{id:String(s.id),x:Number(s.x),y:Number(s.y),floorId:String(s.floorId||""),zoneId:s.zoneId?String(s.zoneId):void 0,zoneName:s.zoneName?String(s.zoneName):void 0,zoneColor:s.zoneColor?String(s.zoneColor):void 0,priceTierId:i,priceTierColor:u?.color,rowLabel:String(s.rowLabel??""),seatLabel:String(s.seatLabel??""),status:_||I?"disabled":"available",locked:_||r||m||I,isSold:r,isShowDisabled:m}})}),Oe=S(()=>x.value[y.value]||[]),Ze=S(()=>{const t=Oe.value;if(!t.length)return 0;const e=new Set(t);return K.value.filter(a=>e.has(a.id)).length}),Ce=S(()=>{const t=[],e=x.value;return Object.keys(e).forEach(a=>{const o=e[a];if(!o||o.length===0)return;const l=h.value[a];if(!l)return;const u=b.value.find(_=>_.id===l.showId)?.name||"",i=re.value[l.venueId]||"",r=new Map;o.forEach(_=>{const N=Se(a,_),I=ae.value[N];if(!I)return;const n=I.priceTierId||"__unassigned__";r.has(n)||r.set(n,{priceTierId:n,name:I.priceTierName||"未分配票档",priceCents:I.priceCents,color:I.priceTierColor,seats:[]}),r.get(n).seats.push(I)});const m=Array.from(r.values());m.length&&(m.sort((_,N)=>N.priceCents-_.priceCents),t.push({sessionId:a,showId:l.showId,showName:u,session:l,venueName:i,groups:m}))}),t.sort((a,o)=>a.session.date===o.session.date?(a.session.startTime||"").localeCompare(o.session.startTime||""):a.session.date.localeCompare(o.session.date)),t}),ta=v([]),xe=S(()=>Object.values(x.value).reduce((e,a)=>e+(a?a.length:0),0)),je=S(()=>Ce.value.reduce((t,e)=>{const a=e.groups.reduce((o,l)=>o+l.priceCents*l.seats.length,0);return t+a},0));function Ye(t){return(t/100).toFixed(2)}function Ve(t){if(!t)return"";const e=re.value[t.venueId]||"未知场馆",a=t.startTime,o=oe(`${t.date} ${t.startTime}`).add(t.durationMinutes||0,"minute").format("HH:mm");return`${e} ${a}-${o}`}async function Ie(){const e=ke.value?.venueId;if(!e)return;let a=ie[e];a||(a=await Ee(e),ie[e]=a),re.value[e]=a.name,he.value[e]=(a.zones||[]).map(o=>String(o.id)),Z.value=a.name,j.value=(a.floors||[]).map((o,l)=>({id:String(o.id),name:String(o.name||`F${l+1}`)})),Y.value=a.seats||[],_e.value=a.seatMapConfig?.stage,ee.value=j.value[0]?.id||""}function X(t){x.value[t]||(x.value[t]=[])}function J(t,e){x.value[t]=e;const a=new Set(e),o={};if(Object.entries(ae.value).forEach(([l,s])=>{if(!l.startsWith(`${t}__`)){o[l]=s;return}const i=l.split("__")[1];i&&a.has(i)&&(o[l]=s)}),t===y.value){const l=new Map(K.value.map(s=>[s.id,s]));e.forEach(s=>{const u=l.get(s);if(!u)return;const i=w.value.find(m=>m.id===u.priceTierId),r=i?Math.round(Number(i.price)*100):0;o[Se(t,s)]={...u,showId:W.value,sessionId:t,venueId:ke.value?.venueId||"",priceTierName:i?.name||"未分配票档",priceCents:r}})}ae.value=o}function Ke(t){const e=y.value;if(!e||t.length===0)return;X(e);const a=new Map(K.value.map(r=>[r.id,r])),o=new Set(K.value.filter(r=>!r.locked).map(r=>r.id)),l=t.filter(r=>o.has(r));if(t.length>0&&l.length===0){const r=t.length===1?t[0]:"",m=r?a.get(r):void 0;if(m?.isSold){se.warning("该座位已售");return}if(m?.isShowDisabled){se.warning("该座位已被演出禁用");return}se.warning("该座位不可售");return}const u=x.value[e]||[];if(l.length===1){const r=l[0],m=a.get(r);if(!m||m.locked){se.warning("该座位不可售");return}const _=u.includes(r)?u.filter(N=>N!==r):[...u,r];J(e,_);return}const i=Array.from(new Set([...u,...l]));x.value[e]=i,J(e,x.value[e])}function Je(t,e){const a=e||y.value;if(!a)return;X(a);const l=x.value[a].filter(s=>s!==t);J(a,l)}function Qe(t,e){const a=e||y.value;if(!a)return;X(a);const l=x.value[a].filter(s=>{const u=Se(a,s);return(ae.value[u]?.priceTierId||"__unassigned__")!==t});J(a,l)}function qe(t){t&&J(t,[])}function et(){x.value={},ae.value={}}function de(){const t=new Set(K.value.filter(o=>!o.locked).map(o=>o.id)),e=y.value;if(!e)return;X(e);const a=x.value[e].filter(o=>t.has(o));J(e,a)}function tt(){ye.value+=1,de()}function Fe(t){const e=t===1?1.1:.9090909090909091,a=Math.min(3,Math.max(.5,P.value.scale*e));P.value={...P.value,scale:a}}function Te(){const t=ee.value,e=Y.value.filter(H=>t?H.floorId===t:!0),a=_e.value;if(!e.length&&!a){P.value={offsetX:U.value.width/2,offsetY:U.value.height/2,scale:1};return}const o=20;let l=1/0,s=-1/0,u=1/0,i=-1/0;if(e.forEach(H=>{const ne=Number(H.x),pe=Number(H.y);l=Math.min(l,ne),u=Math.min(u,pe),s=Math.max(s,ne+o),i=Math.max(i,pe+o)}),a){const H=a.width||0,ne=a.height||40,pe=a.x-H/2,rt=a.x+H/2,ct=a.y-ne/2,ut=a.y+ne/2;l=Math.min(l,pe),s=Math.max(s,rt),u=Math.min(u,ct),i=Math.max(i,ut)}const r=Math.max(s-l,1),m=Math.max(i-u,1),_=40,N=Math.max(U.value.width,_*2+1),I=Math.max(U.value.height,_*2+1),n=(N-_*2)/r,T=(I-_*2)/m,V=Math.min(n,T),fe=Math.min(V*1.4*1.6,3),it=l+r/2;P.value={offsetX:N/2-it*fe,offsetY:60-u*fe,scale:fe}}function at(t){P.value=t}async function nt(){try{le.value=!0;const e=await St({page:1,pageSize:50});b.value=e.list||[],M.value=e.list||[],$.value&&!b.value.some(a=>a.id===$.value)&&($.value="")}catch(t){console.error(t)}finally{le.value=!1}}async function ve(t){try{G.value=!0;const e=await bt(t);W.value=e.show.id;const a=e.sessions||[];O.value=a,w.value=e.priceTiers||[],a.forEach(i=>{h.value[i.id]=i});const o=Array.from(new Set((O.value||[]).map(i=>i.venueId).filter(i=>!!i)));await Promise.all(o.map(async i=>{if(!i||ie[i])return;const r=await Ee(i);ie[i]=r,re.value[i]=r.name,he.value[i]=(r.zones||[]).map(m=>String(m.id))}));const s=Be.value[0]||O.value[0]?.date;q.value=s?oe(s):null;const u=ce.value[0]||O.value[0];y.value=u?.id||"",y.value&&X(y.value),await Ie(),A.value=[],ye.value=0,Te(),we.value=!0}catch(e){console.error(e)}finally{G.value=!1}}Q(()=>q.value?.format("YYYY-MM-DD"),t=>{if(!t)return;const e=ce.value[0];e&&e.id!==y.value&&(y.value=e.id,X(e.id),de(),Ie())}),Q(()=>y.value,t=>{t&&(X(t),de(),Ie())}),vt(async()=>{Ue(),await nt();const t=b.value[0];t&&await ve(t.id)}),ft(()=>{te?.disconnect(),te=null});async function st(t){if(!t)return;$.value="",be.value=!0;const e=b.value.find(a=>a.id===t);B.value=e?.name||"",R.value=!1,window.setTimeout(()=>{be.value=!1},0),await ve(t)}async function ot(t){t&&($.value="",R.value=!1,B.value="",await ve(t))}async function lt(){B.value="",$.value="",R.value=!1;const t=(M.value.length?M.value:b.value)[0];t&&await ve(t.id)}function Le(t){const e=A.value;e.includes(t)?A.value=e.filter(a=>a!==t):A.value=[...e,t]}return Q(()=>A.value,()=>{de()}),Q(()=>B.value,(t,e)=>{be.value||e&&!t&&lt()}),(t,e)=>{const a=z("a-button"),o=z("a-space"),l=z("a-input"),s=z("a-menu-item"),u=z("a-menu"),i=z("a-dropdown"),r=z("a-select-option"),m=z("a-select"),_=z("a-card"),N=z("a-empty"),I=z("a-tag");return p(),D("div",It,[f(_,{class:"ticketing-sale__filters",bordered:!1},{default:c(()=>[d("div",Tt,[e[11]||(e[11]=d("div",{class:"filter-label"},"演出名称：",-1)),d("div",zt,[f(o,{size:10,wrap:""},{default:c(()=>[f(o,{size:10,wrap:"",class:"show-buttons"},{default:c(()=>[(p(!0),D(F,null,L(Xe.value,n=>(p(),k(a,{key:n.id,type:W.value===n.id?"primary":"default",ghost:W.value===n.id,onClick:T=>ot(n.id)},{default:c(()=>[C(g(n.name),1)]),_:2},1032,["type","ghost","onClick"]))),128))]),_:1}),f(i,{open:R.value,trigger:["click"],onOpenChange:e[4]||(e[4]=n=>R.value=n)},{overlay:c(()=>[d("div",Mt,[f(u,{onClick:e[3]||(e[3]=n=>st(String(n.key)))},{default:c(()=>[(p(!0),D(F,null,L(Re.value,n=>(p(),k(s,{key:n.id},{default:c(()=>[C(g(n.name),1)]),_:2},1024))),128))]),_:1})])]),default:c(()=>[f(l,{value:B.value,"onUpdate:value":e[0]||(e[0]=n=>B.value=n),"allow-clear":"",placeholder:"请输入演出名称匹配具体的演出",style:{width:"360px"},onFocus:e[1]||(e[1]=n=>R.value=!0),onClick:e[2]||(e[2]=n=>R.value=!0)},{prefix:c(()=>[f(E(pt))]),_:1},8,["value"])]),_:1},8,["open"])]),_:1})])]),d("div",Nt,[e[12]||(e[12]=d("div",{class:"filter-label"},"演出日期：",-1)),d("div",$t,[f(xt,{value:q.value,"onUpdate:value":e[5]||(e[5]=n=>q.value=n),style:{width:"160px"},placeholder:"请选择","disabled-date":n=>!Be.value.includes(n.format("YYYY-MM-DD"))},null,8,["value","disabled-date"])])]),d("div",Dt,[e[13]||(e[13]=d("div",{class:"filter-label"},"演出场次：",-1)),d("div",Bt,[f(m,{value:y.value,"onUpdate:value":e[6]||(e[6]=n=>y.value=n),style:{width:"220px"},placeholder:"请选择"},{default:c(()=>[(p(!0),D(F,null,L(ce.value,n=>(p(),k(r,{key:n.id,value:n.id},{default:c(()=>[C(g(Ve(n)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),d("div",Ot,[e[16]||(e[16]=d("div",{class:"filter-label"},"演出票档：",-1)),d("div",Yt,[f(o,{size:10,wrap:"",class:"tier-buttons"},{default:c(()=>[j.value.length>1?(p(),k(m,{key:0,value:ee.value,"onUpdate:value":e[7]||(e[7]=n=>ee.value=n),style:{width:"120px"},placeholder:"楼层"},{default:c(()=>[(p(!0),D(F,null,L(j.value,n=>(p(),k(r,{key:n.id,value:n.id},{default:c(()=>[C(g(n.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):ze("",!0),(p(!0),D(F,null,L(ue.value.slice(0,3),n=>(p(),k(a,{key:n.id,class:_t(["tier-button",{"tier-button--active":A.value.includes(n.id)}]),style:mt(n.color?{"--tier-color":n.color}:{}),onClick:T=>Le(n.id)},{default:c(()=>[C(g(n.name)+" ￥"+g(n.price),1)]),_:2},1032,["class","style","onClick"]))),128)),ue.value.length>3?(p(),k(i,{key:1},{overlay:c(()=>[f(u,null,{default:c(()=>[(p(!0),D(F,null,L(ue.value.slice(3),n=>(p(),k(s,{key:n.id,onClick:T=>Le(n.id)},{default:c(()=>[C(g(n.name)+" ￥"+g(n.price),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:c(()=>[f(a,null,{default:c(()=>[...e[14]||(e[14]=[C("更多",-1)])]),_:1})]),_:1})):ze("",!0)]),_:1}),f(a,{type:"primary",loading:G.value,onClick:tt},{icon:c(()=>[f(E(ht))]),default:c(()=>[e[15]||(e[15]=C(" 刷新座位 ",-1))]),_:1},8,["loading"])])])]),_:1}),d("div",Vt,[f(_,{class:"ticketing-sale__canvas",bordered:!1},{default:c(()=>[d("div",Ft,[d("div",Lt,[d("span",Et,g(Z.value||"座位图"),1),d("span",At,"已选 "+g(Ze.value)+" 个",1)]),d("div",Pt,[f(a,{onClick:e[8]||(e[8]=n=>Fe(1))},{icon:c(()=>[f(E(gt))]),_:1}),f(a,{onClick:e[9]||(e[9]=n=>Fe(-1))},{icon:c(()=>[f(E(wt))]),_:1}),f(a,{onClick:Te},{default:c(()=>[...e[17]||(e[17]=[C("重置",-1)])]),_:1})])]),d("div",{class:"canvas-container",ref_key:"canvasContainerRef",ref:ge},[Y.value.length?(p(),k(yt,{key:0,seats:K.value,stage:_e.value,"enable-stage-interaction":!1,"enable-seat-drag":!1,"selected-seat-ids":Oe.value,"selected-element":null,width:U.value.width,height:U.value.height,"show-grid":!1,"enable-snap":!1,"show-seat-labels":!0,viewport:P.value,onSeatSelect:Ke,onViewportChange:at},null,8,["seats","stage","selected-seat-ids","width","height","viewport"])):(p(),k(N,{key:1,description:"该演出场馆暂不支持精确选座"}))],512)]),_:1}),f(_,{class:"ticketing-sale__cart",bordered:!1},{default:c(()=>[d("div",Ut,[d("div",Rt,"消费清单("+g(xe.value)+")",1),f(a,{type:"text",disabled:!xe.value,onClick:et},{icon:c(()=>[f(E(Me))]),_:1},8,["disabled"])]),ze("",!0),d("div",Xt,[Ce.value.length?(p(!0),D(F,{key:0},L(Ce.value,n=>(p(),D("div",{key:n.sessionId,class:"cart-session"},[f(_,{size:"small",class:"cart-session-card","body-style":{padding:"10px 12px"}},{default:c(()=>[d("div",Ht,[d("div",Gt," 演出场次： "+g(n.showName?n.showName+" ":"")+g(Ve(n.session)),1),f(a,{type:"text",size:"small",onClick:T=>qe(n.sessionId)},{icon:c(()=>[f(E(Me))]),_:1},8,["onClick"])])]),_:2},1024),(p(!0),D(F,null,L(n.groups,T=>(p(),k(_,{key:`${n.sessionId}-${T.priceTierId}`,size:"small",class:"cart-tier-card","body-style":{padding:"10px 12px"}},{default:c(()=>[d("div",Wt,[d("div",Zt,g(T.name)+" ¥"+g(Ye(T.priceCents)),1),f(a,{type:"text",size:"small",onClick:V=>Qe(T.priceTierId,n.sessionId)},{icon:c(()=>[f(E(Me))]),_:1},8,["onClick"])]),d("div",jt,[(p(!0),D(F,null,L(T.seats,V=>(p(),k(I,{key:V.id,color:"blue",closable:"",onClose:me(fe=>Je(V.id,n.sessionId),["prevent"])},{default:c(()=>[C(g(V.zoneName||"")+" "+g(V.rowLabel)+"排"+g(V.seatLabel)+"座 ",1)]),_:2},1032,["onClose"]))),128))])]),_:2},1024))),128))]))),128)):(p(),k(N,{key:2,description:"请选择座位"}))]),d("div",Kt,[d("div",Jt,[d("span",Qt,"￥"+g(Ye(je.value)),1)]),f(a,{type:"primary",disabled:!xe.value,onClick:e[10]||(e[10]=n=>E(se).success("已提交结算（演示）"))},{default:c(()=>[...e[18]||(e[18]=[C(" 去结算 ",-1)])]),_:1},8,["disabled"])])]),_:1})])])}}}),sa=Pe(ea,[["__scopeId","data-v-a62f45cc"]]);export{sa as T};
