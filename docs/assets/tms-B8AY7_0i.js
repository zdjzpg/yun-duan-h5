import{d as Ue,E as f,y as q,aN as I,aQ as x,o as p,aP as c,a as v,B as d,be as _e,b,bN as dt,bL as le,_ as Pe,k as S,x as vt,A as ft,c as $,F,r as E,t as g,al as L,bO as pt,aO as ze,aV as _t,bP as mt,bQ as ht,aZ as gt,aY as wt,b4 as yt,b9 as Me,aU as oe}from"./demo-Dc48I9yq.js";import{_ as St,f as bt,a as kt,b as Ae}from"./theater-Bz5nSc1S.js";const Ct={class:"y-date-footer"},xt=Ue({__name:"YDatePicker",props:{value:{}},emits:["update:value","change"],setup(Ne,{emit:ie}){const W=Ne,O=ie,k=f(!1),M=f(W.value??null);q(()=>W.value,w=>{M.value=w??null}),q(M,w=>{O("update:value",w)});const N=w=>{k.value=w},Z=(w,h)=>{O("change",w,h)},Y=w=>{if(w==="close"){k.value=!1;return}if(w==="clear"){M.value=null;return}w==="now"&&(M.value=le())};return(w,h)=>{const j=I("a-button"),G=I("a-date-picker");return p(),x(G,dt({value:M.value,"onUpdate:value":h[3]||(h[3]=V=>M.value=V),open:k.value,"show-today":!1,"allow-clear":!1},w.$attrs,{onOpenChange:N,onChange:Z}),{renderExtraFooter:c(()=>[v("div",Ct,[d(j,{onClick:h[0]||(h[0]=_e(V=>Y("close"),["stop"])),class:"button button-close"},{default:c(()=>[...h[4]||(h[4]=[b(" 关闭 ",-1)])]),_:1}),v("div",null,[d(j,{onClick:h[1]||(h[1]=_e(V=>Y("clear"),["stop"])),class:"button button-clear"},{default:c(()=>[...h[5]||(h[5]=[b(" 清空 ",-1)])]),_:1}),d(j,{type:"primary",onClick:h[2]||(h[2]=_e(V=>Y("now"),["stop"])),class:"button button-now"},{default:c(()=>[...h[6]||(h[6]=[b(" 现在时间 ",-1)])]),_:1})])])]),_:1},16,["value","open"])}}}),It=Pe(xt,[["__scopeId","data-v-04411221"]]),Tt={class:"ticketing-sale"},zt={class:"filter-row"},Mt={class:"filter-content"},Nt={class:"show-dropdown"},Dt={class:"filter-row"},Bt={class:"filter-content"},$t={class:"filter-row"},Ot={class:"filter-content"},Yt={class:"filter-row"},Vt={class:"filter-content filter-content--between"},Ft={class:"ticketing-sale__body"},Et={class:"canvas-header"},Lt={class:"canvas-title"},At={class:"canvas-title__name"},Ut={class:"canvas-title__sub"},Pt={class:"canvas-actions"},Rt={class:"cart-header"},Xt={class:"cart-title"};const Ht={class:"cart-content"},Wt={class:"cart-session-card__row"},Zt={class:"cart-session-card__text"},jt={class:"cart-tier-card__header"},Gt={class:"cart-tier-card__title"},Qt={class:"cart-tier-card__seats"};const Kt={class:"cart-footer"},qt={class:"total"},Jt={class:"total__amount"},ea=3,ta=Ue({__name:"index",setup(Ne){const ie=f(!1),W=f(!1),O=f(""),k=f([]),M=f([]),N=f(""),Z=f(""),Y=f([]),w=f([]),h=f({}),j=f(""),G=f([]),V=f([]),me=f(void 0),re={},ce=f({}),he=f({}),J=f(null),y=f(""),ee=f(""),U=f([]),P=f({offsetX:400,offsetY:300,scale:1}),ge=f(null),R=f({width:900,height:620}),we=f(!1);let te=null;const Re=()=>{!ge.value||typeof ResizeObserver>"u"||(te?.disconnect(),te=new ResizeObserver(t=>{const e=t[0];if(!e)return;const a=e.contentRect;R.value={width:Math.max(360,Math.floor(a.width)),height:Math.max(360,Math.floor(a.height))},we.value||(Te(),we.value=!0)}),te.observe(ge.value))},T=f({}),ye=f(0),ae=f({});function Se(t,e){return`${t}__${e}`}const ne=f(!1),be=f(!1),Xe=S(()=>{const t=O.value.trim().toLowerCase();return t?k.value.filter(e=>e.name.toLowerCase().includes(t)):k.value}),De=S(()=>(M.value.length?M.value:k.value).slice(0,ea)),He=S(()=>{if(!N.value)return De.value;const t=k.value.find(a=>a.id===N.value),e=De.value.filter(a=>a.id!==N.value);return t?[t,...e]:e}),Be=S(()=>{const t=new Map;return Y.value.forEach(e=>{t.has(e.date)||t.set(e.date,[]),t.get(e.date).push(e)}),Array.from(t.values()).forEach(e=>e.sort((a,o)=>(a.startTime||"").localeCompare(o.startTime||""))),t}),$e=S(()=>Array.from(Be.value.keys()).sort()),ke=S(()=>(ue.value||[]).find(t=>t.id===y.value)||Y.value.find(t=>t.id===y.value)||null),ue=S(()=>{const t=J.value,e=t?t.format("YYYY-MM-DD"):"";if(!e)return[];const a=[...Be.value.get(e)||[]];if(!a.length)return[];const o=le(),l=o.format("YYYY-MM-DD");if(e===l){const s=[],u=[];return a.forEach(i=>{le(`${i.date} ${i.startTime}`).isBefore(o)?u.push(i):s.push(i)}),s.sort((i,r)=>(i.startTime||"").localeCompare(r.startTime||"")),u.sort((i,r)=>(i.startTime||"").localeCompare(r.startTime||"")),[...s,...u]}return a.sort((s,u)=>(s.startTime||"").localeCompare(u.startTime||"")),a}),de=S(()=>{const t=[...w.value],a=ke.value?.venueId;if(a){const o=he.value[a]||[],l=new Set(o);l.size&&t.splice(0,t.length,...t.filter(s=>{const u=s.zoneIds||[];return u.length?u.some(i=>l.has(i)):!0}))}return t.sort((o,l)=>(o.name||"").localeCompare(l.name||"")),t}),We=S(()=>{const t=new Map;return de.value.forEach(e=>{(e.zoneIds||[]).forEach(a=>t.set(a,e))}),t});function Ze(t){let e=2166136261;for(let a=0;a<t.length;a++)e^=t.charCodeAt(a),e=Math.imul(e,16777619);return e>>>0}const je=S(()=>{const t=y.value,e=new Set,a=new Set;if(!t)return{sold:e,showDisabled:a};for(const o of V.value){const l=String(o.id),s=Ze(`${t}|${l}|${ye.value}`)%100;s<12?e.add(l):s<16&&a.add(l)}return{sold:e,showDisabled:a}}),Q=S(()=>{const t=ee.value,{sold:e,showDisabled:a}=je.value,o=U.value,l=o.length>0;return V.value.filter(s=>t?s.floorId===t:!0).map(s=>{const u=We.value.get(s.zoneId),i=u?.id,r=e.has(String(s.id)),_=a.has(String(s.id)),m=s.status==="disabled",C=!(l?i?o.includes(i):!1:!0);return{id:String(s.id),x:Number(s.x),y:Number(s.y),floorId:String(s.floorId||""),zoneId:s.zoneId?String(s.zoneId):void 0,zoneName:s.zoneName?String(s.zoneName):void 0,zoneColor:s.zoneColor?String(s.zoneColor):void 0,priceTierId:i,priceTierColor:u?.color,rowLabel:String(s.rowLabel??""),seatLabel:String(s.seatLabel??""),status:m||C?"disabled":"available",locked:m||r||_||C,isSold:r,isShowDisabled:_}})}),Oe=S(()=>T.value[y.value]||[]),Ge=S(()=>{const t=Oe.value;if(!t.length)return 0;const e=new Set(t);return Q.value.filter(a=>e.has(a.id)).length}),Ce=S(()=>{const t=[],e=T.value;return Object.keys(e).forEach(a=>{const o=e[a];if(!o||o.length===0)return;const l=h.value[a];if(!l)return;const u=k.value.find(m=>m.id===l.showId)?.name||"",i=ce.value[l.venueId]||"",r=new Map;o.forEach(m=>{const D=Se(a,m),C=ae.value[D];if(!C)return;const A=C.priceTierId||"__unassigned__";r.has(A)||r.set(A,{priceTierId:A,name:C.priceTierName||"未分配票档",priceCents:C.priceCents,color:C.priceTierColor,seats:[]}),r.get(A).seats.push(C)});const _=Array.from(r.values());_.length&&(_.sort((m,D)=>D.priceCents-m.priceCents),t.push({sessionId:a,showId:l.showId,showName:u,session:l,venueName:i,groups:_}))}),t.sort((a,o)=>a.session.date===o.session.date?(a.session.startTime||"").localeCompare(o.session.startTime||""):a.session.date.localeCompare(o.session.date)),t}),aa=f([]),xe=S(()=>Object.values(T.value).reduce((e,a)=>e+(a?a.length:0),0)),Qe=S(()=>Ce.value.reduce((t,e)=>{const a=e.groups.reduce((o,l)=>o+l.priceCents*l.seats.length,0);return t+a},0));function Ye(t){return(t/100).toFixed(2)}function Ve(t){if(!t)return"";const e=ce.value[t.venueId]||"未知场馆",a=t.startTime,o=le(`${t.date} ${t.startTime}`).add(t.durationMinutes||0,"minute").format("HH:mm");return`${e} ${a}-${o}`}async function Ie(){const e=ke.value?.venueId;if(!e)return;let a=re[e];a||(a=await Ae(e),re[e]=a),ce.value[e]=a.name,he.value[e]=(a.zones||[]).map(o=>String(o.id)),j.value=a.name,G.value=(a.floors||[]).map((o,l)=>({id:String(o.id),name:String(o.name||`F${l+1}`)})),V.value=a.seats||[],me.value=a.seatMapConfig?.stage,ee.value=G.value[0]?.id||""}function X(t){T.value[t]||(T.value[t]=[])}function K(t,e){T.value[t]=e;const a=new Set(e),o={};if(Object.entries(ae.value).forEach(([l,s])=>{if(!l.startsWith(`${t}__`)){o[l]=s;return}const i=l.split("__")[1];i&&a.has(i)&&(o[l]=s)}),t===y.value){const l=new Map(Q.value.map(s=>[s.id,s]));e.forEach(s=>{const u=l.get(s);if(!u)return;const i=w.value.find(_=>_.id===u.priceTierId),r=i?Math.round(Number(i.price)*100):0;o[Se(t,s)]={...u,showId:Z.value,sessionId:t,venueId:ke.value?.venueId||"",priceTierName:i?.name||"未分配票档",priceCents:r}})}ae.value=o}function Ke(t){const e=y.value;if(!e||t.length===0)return;X(e);const a=new Map(Q.value.map(r=>[r.id,r])),o=new Set(Q.value.filter(r=>!r.locked).map(r=>r.id)),l=t.filter(r=>o.has(r));if(t.length>0&&l.length===0){const r=t.length===1?t[0]:"",_=r?a.get(r):void 0;if(_?.isSold){oe.warning("该座位已售");return}if(_?.isShowDisabled){oe.warning("该座位已被演出禁用");return}oe.warning("该座位不可售");return}const u=T.value[e]||[];if(l.length===1){const r=l[0],_=a.get(r);if(!_||_.locked){oe.warning("该座位不可售");return}const m=u.includes(r)?u.filter(D=>D!==r):[...u,r];K(e,m);return}const i=Array.from(new Set([...u,...l]));T.value[e]=i,K(e,T.value[e])}function qe(t,e){const a=e||y.value;if(!a)return;X(a);const l=T.value[a].filter(s=>s!==t);K(a,l)}function Je(t,e){const a=e||y.value;if(!a)return;X(a);const l=T.value[a].filter(s=>{const u=Se(a,s);return(ae.value[u]?.priceTierId||"__unassigned__")!==t});K(a,l)}function et(t){t&&K(t,[])}function tt(){T.value={},ae.value={}}function ve(){const t=new Set(Q.value.filter(o=>!o.locked).map(o=>o.id)),e=y.value;if(!e)return;X(e);const a=T.value[e].filter(o=>t.has(o));K(e,a)}function at(){ye.value+=1,ve()}function Fe(t){const e=t===1?1.1:.9090909090909091,a=Math.min(3,Math.max(.5,P.value.scale*e));P.value={...P.value,scale:a}}function Te(){const t=ee.value,e=V.value.filter(H=>t?H.floorId===t:!0),a=me.value;if(!e.length&&!a){P.value={offsetX:R.value.width/2,offsetY:R.value.height/2,scale:1};return}const o=20;let l=1/0,s=-1/0,u=1/0,i=-1/0;if(e.forEach(H=>{const se=Number(H.x),pe=Number(H.y);l=Math.min(l,se),u=Math.min(u,pe),s=Math.max(s,se+o),i=Math.max(i,pe+o)}),a){const H=a.width||0,se=a.height||40,pe=a.x-H/2,rt=a.x+H/2,ct=a.y-se/2,ut=a.y+se/2;l=Math.min(l,pe),s=Math.max(s,rt),u=Math.min(u,ct),i=Math.max(i,ut)}const r=Math.max(s-l,1),_=Math.max(i-u,1),m=40,D=Math.max(R.value.width,m*2+1),C=Math.max(R.value.height,m*2+1),A=(D-m*2)/r,n=(C-m*2)/_,z=Math.min(A,n),B=Math.min(z*1.4*1.6,3),Le=l+r/2;P.value={offsetX:D/2-Le*B,offsetY:60-u*B,scale:B}}function nt(t){P.value=t}async function st(){try{ie.value=!0;const e=await bt({page:1,pageSize:50});k.value=e.list||[],M.value=e.list||[],N.value&&!k.value.some(a=>a.id===N.value)&&(N.value="")}catch(t){console.error(t)}finally{ie.value=!1}}async function fe(t){try{W.value=!0;const e=await kt(t);Z.value=e.show.id;const a=e.sessions||[];Y.value=a,w.value=e.priceTiers||[],a.forEach(i=>{h.value[i.id]=i});const o=Array.from(new Set((Y.value||[]).map(i=>i.venueId).filter(i=>!!i)));await Promise.all(o.map(async i=>{if(!i||re[i])return;const r=await Ae(i);re[i]=r,ce.value[i]=r.name,he.value[i]=(r.zones||[]).map(_=>String(_.id))}));const s=$e.value[0]||Y.value[0]?.date;J.value=s?le(s):null;const u=ue.value[0]||Y.value[0];y.value=u?.id||"",y.value&&X(y.value),await Ie(),U.value=[],ye.value=0,Te(),we.value=!0}catch(e){console.error(e)}finally{W.value=!1}}q(()=>J.value?.format("YYYY-MM-DD"),t=>{if(!t)return;const e=ue.value[0];e&&e.id!==y.value&&(y.value=e.id,X(e.id),ve(),Ie())}),q(()=>y.value,t=>{t&&(X(t),ve(),Ie())}),vt(async()=>{Re(),await st();const t=k.value[0];t&&await fe(t.id)}),ft(()=>{te?.disconnect(),te=null});async function ot(t){if(!t)return;N.value="",be.value=!0;const e=k.value.find(a=>a.id===t);O.value=e?.name||"",ne.value=!1,window.setTimeout(()=>{be.value=!1},0),await fe(t)}async function lt(t){t&&(N.value="",ne.value=!1,O.value="",await fe(t))}async function it(){O.value="",N.value="",ne.value=!1;const t=(M.value.length?M.value:k.value)[0];t&&await fe(t.id)}function Ee(t){const e=U.value;e.includes(t)?U.value=e.filter(a=>a!==t):U.value=[...e,t]}return q(()=>U.value,()=>{ve()}),q(()=>O.value,(t,e)=>{be.value||e&&!t&&it()}),(t,e)=>{const a=I("a-button"),o=I("a-space"),l=I("a-input"),s=I("a-menu-item"),u=I("a-menu"),i=I("a-dropdown"),r=I("a-select-option"),_=I("a-select"),m=I("a-card"),D=I("a-tooltip"),C=I("a-empty"),A=I("a-tag");return p(),$("div",Tt,[d(m,{class:"ticketing-sale__filters",bordered:!1},{default:c(()=>[v("div",zt,[e[9]||(e[9]=v("div",{class:"filter-label"},"演出名称：",-1)),v("div",Mt,[d(o,{size:10,wrap:""},{default:c(()=>[d(o,{size:10,wrap:"",class:"show-buttons"},{default:c(()=>[(p(!0),$(F,null,E(He.value,n=>(p(),x(a,{key:n.id,type:Z.value===n.id?"primary":"default",ghost:Z.value===n.id,onClick:z=>lt(n.id)},{default:c(()=>[b(g(n.name),1)]),_:2},1032,["type","ghost","onClick"]))),128))]),_:1}),d(i,{open:ne.value,"onUpdate:open":e[2]||(e[2]=n=>ne.value=n),trigger:"click"},{overlay:c(()=>[v("div",Nt,[d(u,{onClick:e[1]||(e[1]=n=>ot(String(n.key)))},{default:c(()=>[(p(!0),$(F,null,E(Xe.value,n=>(p(),x(s,{key:n.id},{default:c(()=>[b(g(n.name),1)]),_:2},1024))),128))]),_:1})])]),default:c(()=>[d(l,{value:O.value,"onUpdate:value":e[0]||(e[0]=n=>O.value=n),"allow-clear":"",placeholder:"请输入演出名称匹配具体的演出",style:{width:"360px"}},{prefix:c(()=>[d(L(pt))]),_:1},8,["value"])]),_:1},8,["open"])]),_:1})])]),v("div",Dt,[e[10]||(e[10]=v("div",{class:"filter-label"},"演出日期：",-1)),v("div",Bt,[d(It,{value:J.value,"onUpdate:value":e[3]||(e[3]=n=>J.value=n),style:{width:"160px"},placeholder:"请选择","disabled-date":n=>!$e.value.includes(n.format("YYYY-MM-DD"))},null,8,["value","disabled-date"])])]),v("div",$t,[e[11]||(e[11]=v("div",{class:"filter-label"},"演出场次：",-1)),v("div",Ot,[d(_,{value:y.value,"onUpdate:value":e[4]||(e[4]=n=>y.value=n),style:{width:"220px"},placeholder:"请选择"},{default:c(()=>[(p(!0),$(F,null,E(ue.value,n=>(p(),x(r,{key:n.id,value:n.id},{default:c(()=>[b(g(Ve(n)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),v("div",Yt,[e[14]||(e[14]=v("div",{class:"filter-label"},"演出票档：",-1)),v("div",Vt,[d(o,{size:10,wrap:"",class:"tier-buttons"},{default:c(()=>[G.value.length>1?(p(),x(_,{key:0,value:ee.value,"onUpdate:value":e[5]||(e[5]=n=>ee.value=n),style:{width:"120px"},placeholder:"楼层"},{default:c(()=>[(p(!0),$(F,null,E(G.value,n=>(p(),x(r,{key:n.id,value:n.id},{default:c(()=>[b(g(n.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])):ze("",!0),(p(!0),$(F,null,E(de.value.slice(0,3),n=>(p(),x(a,{key:n.id,class:mt(["tier-button",{"tier-button--active":U.value.includes(n.id)}]),style:_t(n.color?{"--tier-color":n.color}:{}),onClick:z=>Ee(n.id)},{default:c(()=>[b(g(n.name)+" ￥"+g(n.price),1)]),_:2},1032,["class","style","onClick"]))),128)),de.value.length>3?(p(),x(i,{key:1},{overlay:c(()=>[d(u,null,{default:c(()=>[(p(!0),$(F,null,E(de.value.slice(3),n=>(p(),x(s,{key:n.id,onClick:z=>Ee(n.id)},{default:c(()=>[b(g(n.name)+" ￥"+g(n.price),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:c(()=>[d(a,null,{default:c(()=>[...e[12]||(e[12]=[b("更多",-1)])]),_:1})]),_:1})):ze("",!0)]),_:1}),d(a,{type:"primary",loading:W.value,onClick:at},{icon:c(()=>[d(L(ht))]),default:c(()=>[e[13]||(e[13]=b(" 刷新座位 ",-1))]),_:1},8,["loading"])])])]),_:1}),v("div",Ft,[d(m,{class:"ticketing-sale__canvas",bordered:!1},{default:c(()=>[v("div",Et,[v("div",Lt,[v("span",At,g(j.value||"座位图"),1),v("span",Ut,"已选 "+g(Ge.value)+" 个",1)]),v("div",Pt,[d(a,{onClick:e[6]||(e[6]=n=>Fe(1))},{icon:c(()=>[d(L(gt))]),_:1}),d(a,{onClick:e[7]||(e[7]=n=>Fe(-1))},{icon:c(()=>[d(L(wt))]),_:1}),d(a,{onClick:Te},{default:c(()=>[...e[15]||(e[15]=[b("重置",-1)])]),_:1}),d(D,{title:"Space + 拖拽 平移画布；Ctrl + 滚轮 缩放画布"},{default:c(()=>[d(a,null,{icon:c(()=>[d(L(yt))]),default:c(()=>[e[16]||(e[16]=b(" 快捷键 ",-1))]),_:1})]),_:1})])]),v("div",{class:"canvas-container",ref_key:"canvasContainerRef",ref:ge},[V.value.length?(p(),x(St,{key:0,seats:Q.value,stage:me.value,"enable-stage-interaction":!1,"enable-seat-drag":!1,"toggle-single-click-select":!0,"selected-seat-ids":Oe.value,"selected-element":null,width:R.value.width,height:R.value.height,"show-grid":!1,"enable-snap":!1,"show-seat-labels":!0,viewport:P.value,onSeatSelect:Ke,onViewportChange:nt},null,8,["seats","stage","selected-seat-ids","width","height","viewport"])):(p(),x(C,{key:1,description:"该演出场馆暂不支持精确选座"}))],512)]),_:1}),d(m,{class:"ticketing-sale__cart",bordered:!1},{default:c(()=>[v("div",Rt,[v("div",Xt,"消费清单("+g(xe.value)+")",1),d(a,{type:"text",disabled:!xe.value,onClick:tt},{icon:c(()=>[d(L(Me))]),_:1},8,["disabled"])]),ze("",!0),v("div",Ht,[Ce.value.length?(p(!0),$(F,{key:0},E(Ce.value,n=>(p(),$("div",{key:n.sessionId,class:"cart-session"},[d(m,{size:"small",class:"cart-session-card","body-style":{padding:"10px 12px"}},{default:c(()=>[v("div",Wt,[v("div",Zt," 演出场次： "+g(n.showName?n.showName+" ":"")+g(Ve(n.session)),1),d(a,{type:"text",size:"small",onClick:z=>et(n.sessionId)},{icon:c(()=>[d(L(Me))]),_:1},8,["onClick"])])]),_:2},1024),(p(!0),$(F,null,E(n.groups,z=>(p(),x(m,{key:`${n.sessionId}-${z.priceTierId}`,size:"small",class:"cart-tier-card","body-style":{padding:"10px 12px"}},{default:c(()=>[v("div",jt,[v("div",Gt,g(z.name)+" ¥"+g(Ye(z.priceCents)),1),d(a,{type:"text",size:"small",onClick:B=>Je(z.priceTierId,n.sessionId)},{icon:c(()=>[d(L(Me))]),_:1},8,["onClick"])]),v("div",Qt,[(p(!0),$(F,null,E(z.seats,B=>(p(),x(A,{key:B.id,color:"blue",closable:"",onClose:_e(Le=>qe(B.id,n.sessionId),["prevent"])},{default:c(()=>[b(g(B.zoneName||"")+" "+g(B.rowLabel)+"排"+g(B.seatLabel)+"座 ",1)]),_:2},1032,["onClose"]))),128))])]),_:2},1024))),128))]))),128)):(p(),x(C,{key:2,description:"请选择座位"}))]),v("div",Kt,[v("div",qt,[v("span",Jt,"￥"+g(Ye(Qe.value)),1)]),d(a,{type:"primary",disabled:!xe.value,onClick:e[8]||(e[8]=n=>L(oe).success("已提交结算（演示）"))},{default:c(()=>[...e[17]||(e[17]=[b(" 去结算 ",-1)])]),_:1},8,["disabled"])])]),_:1})])])}}}),oa=Pe(ta,[["__scopeId","data-v-04e2a767"]]);export{oa as T};
